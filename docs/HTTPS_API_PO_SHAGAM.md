# HTTPS для API — пошаговая инструкция с нуля

Чтобы логин с сайта на Vercel работал без ошибки «XMLHttpRequest error», нужно сделать API доступным по **HTTPS**. Ниже — что это значит и что делать по шагам.

---

## Зачем это нужно (коротко)

- Сайт на Vercel открывается по **https://** (защищённое соединение).
- Браузер **не разрешает** такой странице обращаться к адресу по **http://** (незащищённому). Это правило называется «mixed content».
- Сейчас API у тебя по адресу `http://93.77.185.6:3000` — это как раз **http**, поэтому браузер блокирует запросы и появляется «XMLHttpRequest error».
- **Решение:** сделать так, чтобы API тоже был по **https://**, например `https://api.твой-домен.ru`. Тогда браузер разрешит запросы.

Для этого нужно:
1. Иметь **домен** (или поддомен), который указывает на твою ВМ.
2. На ВМ **включить HTTPS** (скрипт в репозитории это делает сам).
3. В настройках **Vercel** указать этот HTTPS-адрес API.
4. Убедиться, что **порты 80 и 443** открыты для ВМ в Yandex Cloud.

Дальше — каждый шаг подробно.

---

## Шаг 0. Что у тебя уже есть

- ВМ в Yandex Cloud с IP **93.77.185.6**.
- На ВМ запущен бэкенд (Node) на порту **3000**.
- Фронт задеплоен на Vercel (адрес вида `https://my-chat-app.vercel.app` или твой).

Цель: получить адрес вида **https://что-то.какой-то-домен** для этого же бэкенда.

---

## Шаг 1. Домен или поддомен

**Домен** — это имя в интернете, например `example.com` или `mychat.ru`. К домену можно привязать **поддомен**, например `api.mychat.ru` — он будет указывать на твой сервер.

### Вариант А: У тебя уже есть домен

Если домен куплен (например в reg.ru, timeweb, cloudflare и т.п.):

1. Зайди в панель управления доменом (DNS).
2. Создай **A-запись**:
   - **Имя/поддомен:** `api` (или любое: `chat`, `backend` — тогда адрес будет `https://api.твой-домен.ru` или `https://chat.твой-домен.ru`).
   - **Тип:** A.
   - **Значение/IP:** `93.77.185.6` (IP твоей ВМ).
   - TTL можно оставить по умолчанию (300–3600).

3. Сохрани и подожди 5–15 минут (иногда до часа), пока DNS обновится.

Проверка: в терминале на своём компьютере выполни  
`ping api.твой-домен.ru`  
— в ответе должен быть IP `93.77.185.6`.

### Вариант Б: Домена нет — взять бесплатный поддомен

Можно использовать бесплатный сервис **DuckDNS**: он даёт поддомен вида `твой-логин.duckdns.org`, который можно направить на твой IP.

1. Зайди на [https://www.duckdns.org](https://www.duckdns.org).
2. Войди через Google/GitHub и создай поддомен, например `my-chat-api`.
3. В поле **Current IP** введи `93.77.185.6` и нажми Update.

Через пару минут адрес `https://my-chat-api.duckdns.org` будет указывать на твою ВМ. Дальше в инструкции везде вместо `api.твой-домен.ru` подставляй `my-chat-api.duckdns.org` (или как ты назвал).

---

## Шаг 2. Открыть порты 80 и 443 на ВМ в Yandex Cloud

Чтобы с интернета до ВМ доходили запросы по HTTPS, нужно разрешить входящий трафик на порты **80** и **443**.

1. Открой [консоль Yandex Cloud](https://console.yandex.cloud).
2. Выбери каталог, в котором создана ВМ.
3. Перейди: **Compute Cloud** → **Виртуальные машины** → выбери ВМ **chat-server**.
4. Открой вкладку **«Сеть»** (или зайди в **Группы безопасности** и открой группу, привязанную к этой ВМ).
5. Добавь **два правила входящего трафика** (если их ещё нет):
   - Порт **80**, протокол **TCP**, источник **0.0.0.0/0** (или «Любой»).
   - Порт **443**, протокол **TCP**, источник **0.0.0.0/0**.

Сохрани. Без открытых 80 и 443 сертификат и HTTPS не заработают.

---

## Шаг 3. Подключиться к ВМ по SSH

С своего компьютера (из папки с репозиторием):

```bash
ssh -i scripts/.deploy_key ubuntu@93.77.185.6
```

Если попросит подтверждение fingerprint — напиши `yes` и Enter. Должна открыться консоль на ВМ (в приглашении будет что-то вроде `ubuntu@chat-server:~$`).

---

## Шаг 4. Перейти в папку проекта и запустить скрипт HTTPS

На ВМ выполни по очереди:

```bash
cd ~/my_chat_app
```

Проверь, что есть скрипт:

```bash
ls scripts/setup-https-on-vm.sh
```

Если файла нет (например, проект ещё не залит на ВМ), сначала залей код с компьютера (с Mac, из папки репозитория):

```bash
rsync -avz --exclude node_modules --exclude '.env' -e "ssh -i scripts/.deploy_key" ./ ubuntu@93.77.185.6:~/my_chat_app/
```

Потом снова зайди по SSH и выполни:

```bash
chmod +x scripts/setup-https-on-vm.sh
```

Теперь запуск скрипта. Вместо `api.твой-домен.ru` подставь **свой** адрес:
- если свой домен: `api.твой-домен.ru` или `chat.твой-домен.ru`;
- если DuckDNS: `my-chat-api.duckdns.org`.

Одна команда (замени домен на свой):

```bash
sudo DOMAIN=api.твой-домен.ru ./scripts/setup-https-on-vm.sh
```

Пример для DuckDNS:

```bash
sudo DOMAIN=my-chat-api.duckdns.org ./scripts/setup-https-on-vm.sh
```

Скрипт:
- поставит Caddy (программа-прокси с авто-HTTPS);
- получит бесплатный сертификат Let's Encrypt для твоего домена;
- будет перенаправлять запросы с `https://твой-домен` на твой Node на порту 3000.

Если всё прошло без ошибок, в конце будет что-то вроде:  
«HTTPS настроен. API доступен по адресу: https://...»

Проверка с твоего компьютера:

```bash
curl -s https://api.твой-домен.ru/healthz
```

Должно вернуться `ok`. Если ошибка — проверь, что порты 80 и 443 открыты (шаг 2) и что DNS уже указывает на 93.77.185.6 (шаг 1).

---

## Шаг 5. Указать HTTPS-адрес API в Vercel

Чтобы приложение на Vercel ходило на твой API по HTTPS, нужно при сборке подставить этот адрес.

1. Открой [vercel.com](https://vercel.com), зайди в свой проект (твой чат).
2. Вкладка **Settings** → слева **Environment Variables**.
3. Нажми **Add** (или «Add New»).
4. Укажи:
   - **Name:** `API_BASE_URL`
   - **Value:** `https://api.твой-домен.ru` (без слэша в конце; для DuckDNS — `https://my-chat-api.duckdns.org`).
   - Окружение: отметь **Production** (и при желании Preview).
5. Сохрани (**Save**).

После этого нужно **пересобрать** проект, чтобы новая переменная попала в сборку:
- вкладка **Deployments** → у последнего деплоя меню (три точки) → **Redeploy** (или сделай новый коммит и пуш — будет новый деплой).

После деплоя приложение будет обращаться к API по твоему HTTPS-адресу, и «XMLHttpRequest error» при логине должна пропасть.

---

## Шаг 6. Разрешить фронт в CORS на ВМ

Бэкенд должен разрешать запросы с твоего сайта на Vercel. Это делается через переменную **ALLOWED_ORIGINS** в `.env` на ВМ.

1. Снова подключись к ВМ по SSH (если вышел):
   ```bash
   ssh -i scripts/.deploy_key ubuntu@93.77.185.6
   ```

2. Открой файл с переменными окружения:
   ```bash
   nano ~/my_chat_app/my_serve_chat_test/.env
   ```

3. Найди строку **ALLOWED_ORIGINS** (или добавь, если её нет). В ней через запятую перечисли адреса, с которых разрешены запросы. Обязательно добавь адрес своего приложения на Vercel, например:
   ```env
   ALLOWED_ORIGINS=https://my-chat-app.vercel.app,https://api.твой-домен.ru
   ```
   (Замени `my-chat-app.vercel.app` на свой домен Vercel, если он другой.)

4. Сохрани файл в nano: **Ctrl+O**, Enter, затем **Ctrl+X**.

5. Перезапусти бэкенд:
   ```bash
   cd ~/my_chat_app/my_serve_chat_test
   pm2 restart chat-server
   ```

На этом настройка заканчивается.

---

## Краткий чеклист

- [ ] Домен или поддомен (DuckDNS или свой) указывает на IP ВМ **93.77.185.6** (A-запись).
- [ ] В Yandex Cloud для ВМ открыты входящие порты **80** и **443**.
- [ ] По SSH на ВМ выполнено: `sudo DOMAIN=твой-домен ./scripts/setup-https-on-vm.sh`.
- [ ] `curl https://твой-домен/healthz` с твоего компьютера возвращает `ok`.
- [ ] В Vercel в Environment Variables задано **API_BASE_URL** = `https://твой-домен` (без слэша в конце).
- [ ] Сделан **Redeploy** проекта на Vercel (или новый деплой после пуша).
- [ ] В `.env` на ВМ в **ALLOWED_ORIGINS** указан адрес фронта на Vercel, выполнен `pm2 restart chat-server`.

Если что-то из шагов непонятно или не получается — напиши, на каком шаге застрял и какая ошибка (текст из консоли или с экрана).
