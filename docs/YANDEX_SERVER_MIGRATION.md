# План: перенос сервера на Yandex Cloud

Краткий план и пошаговые инструкции. Ничего не нужно делать срочно — это ориентир, когда будешь готов.

---

## Создать ВМ прямо сейчас (чтобы потратить грант)

Минимальная ВМ — только чтобы машина появилась и грант начал списываться. Настраивать сервер на ней можно потом.

### Вариант А: через консоль

1. Открой [Compute Cloud → Виртуальные машины → Создать ВМ](https://console.yandex.cloud/folders/b1glvesspg0e1brhvevg/compute/create-instance) (или свой каталог).
2. **Имя** — любое, например `chat-server`.
3. **Зона** — оставь по умолчанию (например `ru-central1-a`).
4. **Образ** — Ubuntu 22.04 LTS или 24.04 LTS.
5. **Платформа и ресурсы** — выбери минимальный пресет (1–2 vCPU, 1–2 GB RAM). Если есть «Микро» или «Минимальная» — бери его.
6. **Диск** — 10–15 GB.
7. **Сеть** — включи **Публичный адрес** (чтобы потом зайти по SSH и открыть доступ в интернет).
8. **Доступ** — либо загрузить свой SSH-ключ, либо задать пароль для пользователя `ubuntu` (сохрани пароль).
9. Нажми **Создать ВМ**. Дождись статуса «Работает», запиши **публичный IP** — по нему потом подключаться по SSH.

Готово: ВМ создана, грант будет списываться. Дальше — шаги 2–6 из плана ниже, когда захочешь поднять на ней приложение.

### Вариант Б: через CLI (одна команда)

**CLI уже установлен** (через `brew install --cask yandex-cloud-cli`). Осталось один раз авторизоваться и создать ВМ.

1. **Авторизация** — в терминале выполни:
   ```bash
   yc init
   ```
   Откроется или будет указана ссылка для OAuth. Зайди по ней, выдай доступ, скопируй токен и вставь в терминал по запросу. Либо задай токен вручную: `yc config set token <твой-OAuth-токен>`.

2. **Создать ВМ** — из корня репозитория выполни:
   ```bash
   ./scripts/create-yandex-vm.sh
   ```
   (Имя ВМ по умолчанию `chat-server`, зона `ru-central1-a`. Можно передать аргументы: `./scripts/create-yandex-vm.sh <имя> <зона> <подсеть>`.)

   Или вручную:

```bash
yc compute instance create \
  --name chat-server \
  --zone ru-central1-a \
  --cores 2 \
  --memory 2gb \
  --create-boot-disk image-folder-id=standard-images,image-family=ubuntu-2204-lts,size=15gb \
  --network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4 \
  --ssh-key ~/.ssh/id_rsa.pub
```

- Подставь свою подсеть, если не `default-ru-central1-a`: посмотри `yc vpc subnet list`.
- Если ключ не `~/.ssh/id_rsa.pub`, укажи свой путь или добавь `--metadata-from-file user-data=...` с паролем.
- Публичный IP выдастся автоматически (`nat-ip-version=ipv4`). После создания: `yc compute instance get chat-server` — в выводе будет адрес.

---

## Запуск сервера на уже созданной ВМ (chat-server)

ВМ уже есть: **chat-server**, публичный IP **93.77.185.6**. Ключ для SSH добавляется при создании через **cloud-init** (`scripts/cloud-init-ssh.yaml`). Ниже — пошаговый запуск приложения на ней.

### Шаг 1. Подключиться по SSH

В проекте есть ключ для деплоя: **scripts/.deploy_key** (приватный) и **.deploy_key.pub**. Подключение без пароля (после того как ключ добавлен на ВМ, см. блок ниже):

```bash
ssh -i scripts/.deploy_key ubuntu@93.77.185.6
```

**Если форма «Закрытый SSH-ключ» пишет «unable to authenticate»:**
- **Логин** — ровно `ubuntu` (без пробелов).
- **Ключ** — весь файл `scripts/.deploy_key` от первой до последней строки: `-----BEGIN OPENSSH PRIVATE KEY-----` … `-----END OPENSSH PRIVATE KEY-----`. Копируй в терминале: `cat scripts/.deploy_key` → выделить весь вывод, вставить в форму. Без лишних пустых строк в начале/конце.
- Если форма принимает только **файл** — укажи путь к `scripts/.deploy_key` или загрузи этот файл.
- Если всё равно не пускает — возможно, форма ждёт ключ в другом формате или от другой ВМ; тогда добавь ключ через серийную консоль или инструкцию «Восстановление доступа к ВМ» в консоли Yandex.

**Если подключаешься по паролю** (сброс пароля в консоли): на ВМ выполни:
```bash
mkdir -p ~/.ssh && echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIA4rDkbvyojdqjtUS4JNU7u7yajUPq6hB+YllG1tQpe deploy-yandex-vm' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys
```
После этого с Mac будет работать: `ssh -i scripts/.deploy_key ubuntu@93.77.185.6` и `./scripts/deploy-to-yandex-vm-now.sh`.

**Вариант из консоли (SSH-клиент):** `ssh -l ubuntu 93.77.185.6` — с ключом: `ssh -l ubuntu -i scripts/.deploy_key 93.77.185.6`.

**Вариант через CLI Yandex** (из корня репозитория):
```bash
yc compute ssh --id fhmo1h7g2cl6904tl3q4 --identity-file scripts/.deploy_key --login ubuntu --folder-id b1glvesspg0e1brhvevg --public-address
```
Работает после того, как публичный ключ добавлен в `~/.ssh/authorized_keys` на ВМ один раз (см. блок «Если Permission denied» ниже).

### Шаг 2. Загрузить код на ВМ

**Вариант А — с твоего Mac (из каталога с репозиторием):**

```bash
rsync -avz --exclude node_modules --exclude '.env' -e ssh \
  ./ ubuntu@93.77.185.6:~/my_chat_app/
```

Файл `.env` на ВМ создашь вручную (см. шаг 4), чтобы не светить секреты.

**Вариант Б — на ВМ через git (если репозиторий публичный):**

```bash
ssh ubuntu@93.77.185.6
sudo apt-get update && sudo apt-get install -y git
git clone https://github.com/ТВОЙ_ЛОГИН/my_chat_app.git ~/my_chat_app
cd ~/my_chat_app
```

### Шаг 3. Открыть порты на ВМ в Yandex

В [консоли Yandex Cloud](https://console.yandex.cloud) → **Compute Cloud** → **Виртуальные машины** → **chat-server** → вкладка **«Сеть»** (или **Группы безопасности**). Добавь правила входящего трафика:
- Порт **3000** (TCP) — для прямого доступа к API по HTTP.
- Порты **80** и **443** (TCP) — понадобятся для HTTPS (шаг 5а). Источник **0.0.0.0/0** (или только нужные IP).

### Шаг 4. Установить окружение и запустить сервер на ВМ

На ВМ (после SSH):

```bash
cd ~/my_chat_app
chmod +x scripts/setup-server-on-yandex-vm.sh
```

Создай `.env` в каталоге бэкенда (скопируй с Render или с локальной машины и подставь Yandex):

```bash
nano my_serve_chat_test/.env
```

Минимум в `.env`:

- `NODE_ENV=production`
- `PORT=3000`
- `DATABASE_URL=postgresql://chat_app:ПАРОЛЬ@rc1a-fb78j7h9hisgnsll.mdb.yandexcloud.net:6432/chat_db` (без sslmode или с `?sslmode=require` — в коде уже обрабатывается)
- `JWT_SECRET=...` (не короче 32 символов, как на Render)
- `ALLOWED_ORIGINS=https://my-chat-app.vercel.app,http://localhost:3000,...`
- При использовании Object Storage: `YANDEX_ACCESS_KEY_ID`, `YANDEX_SECRET_ACCESS_KEY`, `YANDEX_BUCKET_NAME=mychatimage`

Запуск (один раз, для проверки):

```bash
./scripts/setup-server-on-yandex-vm.sh
```

В логах должно появиться «Подключение к базе данных успешно» и «Server running on port 3000». Проверка с твоего компьютера: `curl http://93.77.185.6:3000/healthz` — ответ `ok`.

Чтобы сервер работал после выхода из SSH и перезагрузки ВМ, на ВМ можно установить **pm2** и запускать через него (см. комментарий в конце скрипта `setup-server-on-yandex-vm.sh`).

### Шаг 5. Переключить приложение на этот сервер

**Сделано:** базовый URL API во Flutter по умолчанию установлен на `http://93.77.185.6:3000` (`lib/config/api_config.dart`). При сборке под другой домен передай `--dart-define=API_BASE_URL=https://твой-домен` или настрой переменные в Vercel.

### Шаг 5а. HTTPS для API (чтобы логин с Vercel работал без «XMLHttpRequest error»)

Если приложение открыто с **Vercel (HTTPS)**, браузер блокирует запросы на HTTP API. Нужно поднять API по HTTPS на ВМ одним скриптом:

1. **Домен:** заведи домен или поддомен (например `api.твой-домен.ru`), создай **A-запись** на IP ВМ (**93.77.185.6**).
2. **На ВМ** (после SSH):
   ```bash
   cd ~/my_chat_app
   chmod +x scripts/setup-https-on-vm.sh
   sudo DOMAIN=api.твой-домен.ru ./scripts/setup-https-on-vm.sh
   ```
   Скрипт ставит **Caddy**, получает сертификат Let's Encrypt и проксирует HTTPS → твой Node на порту 3000.
3. **Порты 80 и 443** должны быть открыты в группе безопасности ВМ (шаг 3).
4. **Vercel:** в настройках проекта → **Environment Variables** добавь **API_BASE_URL** = `https://api.твой-домен.ru` (без слэша в конце). Пересобери/задеплой проект — сборка подставит этот URL в приложение.
5. В **my_serve_chat_test/.env** на ВМ в **ALLOWED_ORIGINS** добавь свой фронт, например `https://my-chat-app.vercel.app`, затем `pm2 restart chat-server`.

**Подробная инструкция с нуля (что такое домен, куда нажимать, какие команды):** [HTTPS_API_PO_SHAGAM.md](HTTPS_API_PO_SHAGAM.md).  
Про ошибку «XMLHttpRequest error»: [XMLHTTPREQUEST_ERROR_AFTER_VM.md](XMLHTTPREQUEST_ERROR_AFTER_VM.md).

### Шаг 6. Автодеплой при изменении кода (GitHub Actions)

При пуше в `main` в каталог `my_serve_chat_test/**` GitHub Actions подключается по SSH к ВМ, подтягивает код и перезапускает сервер. Workflow: `.github/workflows/deploy-yandex-vm.yml`.

**Один раз настроить:**

1. **Ключ деплоя** уже есть в репозитории: `scripts/.deploy_key` и `scripts/.deploy_key.pub` (файлы в .gitignore, не коммитятся). Публичный ключ уже добавлен в метаданные ВМ (или будет при пересоздании ВМ через `create-yandex-vm.sh`).

2. **Секреты в GitHub:** репозиторий → **Settings** → **Secrets and variables** → **Actions** → **New repository secret**:
   - `DEPLOY_HOST` = IP ВМ (например `93.77.185.6`)
   - `DEPLOY_USER` = `ubuntu`
   - `DEPLOY_SSH_KEY` = весь текст приватного ключа: `cat scripts/.deploy_key` (скопировать и вставить в секрет)

3. **На ВМ:** репозиторий должен быть в `~/my_chat_app`, сервер запущен через **pm2** с именем `chat-server`:
   ```bash
   cd ~/my_chat_app/my_serve_chat_test
   npm i -g pm2
   pm2 start index.js --name chat-server
   pm2 save
   pm2 startup   # автозапуск при перезагрузке ВМ
   ```

После этого каждый push в `main` с изменениями в `my_serve_chat_test/` будет запускать workflow: на ВМ выполнится `git pull`, `npm ci`, `pm2 restart chat-server`. Запуск вручную: в GitHub → **Actions** → **Deploy to Yandex VM** → **Run workflow**.

---

## Общая идея

1. Создать виртуальную машину (VM) в Yandex Compute Cloud.
2. Установить на неё Node.js, развернуть приложение из репозитория (или артефакта).
3. Настроить переменные окружения (DATABASE_URL, JWT_SECRET и т.д.), запустить сервис.
4. Открыть доступ в интернет (публичный IP, порт 80/443, при необходимости nginx как reverse proxy).
5. Обновить фронт/клиенты: указать новый URL API вместо Render.

Сервер и БД могут быть в одном облаке (Yandex) — тогда задержки между ними минимальны.

---

## Как сделать максимально дёшево на первое время

**Важно:** у Yandex Compute Cloud нет бесплатного тарифа для VM. Платить придётся с первого дня, но сумму можно снизить.

### Минимальная конфигурация VM

- **Платформа** — стандартная (Intel Broadwell или новее).
- **Конфигурация** — минимальный пресет: 1 vCPU или 2 vCPU с гарантированной долей 5–20%, 1–2 GB RAM. В консоли это варианты типа «Микро» или с пометкой для тестовых нагрузок.
- **Диск** — 10–15 GB на систему и приложение обычно хватает для Node.js-чата.
- **Один инстанс** — без балансировщика и без лишних машин.
- **ОС** — Ubuntu 22.04 LTS или аналогичный образ (бесплатный образ, платишь только за ресурсы).

При такой конфигурации ориентировочно **от ~300–600 ₽/мес** (цены меняются, проверяй в [калькуляторе Yandex Compute Cloud](https://cloud.yandex.ru/docs/compute/pricing) или при создании VM).

### Сетевой трафик

- Исходящий трафик часто тарифицируется отдельно после лимита. Для небольшого API и чата расход обычно небольшой — можно заложить ещё 50–150 ₽/мес или смотреть по факту.

### Если есть ИП/ООО

- Грант 4000 ₽ (при выполнении условий) можно тратить и на VM, и на БД — тогда первые месяцы сервер + БД укладываются в грант.

### Сравнение с Render

| | Render (free) | Render (paid) | Yandex VM (минимальная) |
|---|---|---|---|
| Стоимость | 0 ₽ | от ~7 $/мес | ~300–600 ₽/мес |
| «Засыпание» | да | нет | нет |
| Контроль | ограничен | средний | полный (своя VM) |
| Регион | за рубежом | за рубежом | РФ (при выборе зоны) |

**Итог:** если цель — ноль расходов, оставаться на Render free. Перенос на Yandex имеет смысл, когда нужны стабильная работа без «засыпания», данные в РФ или один провайдер с БД — тогда выбирай минимальную конфигурацию выше.

---

## План по шагам

### Шаг 1. Создать VM в Yandex Compute Cloud

- Зайти в консоль Yandex Cloud → **Compute Cloud** → **Виртуальные машины** → **Создать ВМ**.
- Указать: имя, зону доступности (например, ru-central1-a), образ (Ubuntu 22.04), платформу, конфигурацию (1 vCPU, 1–2 GB RAM), размер диска (10–15 GB).
- Сеть: выбрать подсеть, при необходимости **выдать публичный IP** (чтобы сервер был доступен из интернета).
- Сохранить логин/ключ или пароль для SSH. Дождаться создания и записать **публичный IP** (если выдавали).

Подробности: [документация Compute Cloud](https://cloud.yandex.ru/docs/compute/).

---

### Шаг 2. Подключиться по SSH и подготовить окружение

- Подключиться к VM по SSH (по ключу или паролю).
- Установить Node.js (LTS), при необходимости nginx, git.
- Клонировать репозиторий приложения или загрузить артефакт сборки.
- Установить зависимости: `npm install` в папке `my_serve_chat_test` (или где лежит backend).

---

### Шаг 3. Настроить приложение и переменные окружения

- Создать файл `.env` или задать переменные окружения (DATABASE_URL, JWT_SECRET, ALLOWED_ORIGINS и т.д.). Значения взять из текущего Render или из своей конфигурации.
- При необходимости настроить порт (например, приложение слушает 3000, nginx проксирует 80/443 на 3000).

---

### Шаг 4. Запустить сервис и сделать автозапуск

- Запустить приложение вручную и проверить, что API отвечает (curl с другой машины или с локального компьютера по публичному IP).
- Настроить автозапуск при перезагрузке VM: systemd-юнит или pm2 (если используешь Node process manager).

---

### Шаг 5. Открыть доступ в интернет

- В настройках сети / **Security groups** или **Группы безопасности** ВМ разрешить входящий трафик на порт 80 (HTTP) и при необходимости 443 (HTTPS). Источник — 0.0.0.0/0 или только нужные IP.
- Если используешь nginx — настроить его как reverse proxy на порт приложения (например 3000).
- При желании привязать домен и настроить SSL (Let's Encrypt через certbot).

---

### Шаг 6. Переключить клиенты на новый сервер

- Обновить базовый URL API во фронтенде (Vercel/Flutter и т.д.) с адреса Render на новый адрес Yandex (по IP или по домену).
- Проверить логины, чаты, загрузки. После проверки можно отключить сервис на Render.

---

## Чек-лист (когда будешь делать)

- [ ] VM в Yandex создана, есть публичный IP и доступ по SSH.
- [ ] Установлены Node.js, зависимости, приложение развёрнуто.
- [ ] Переменные окружения заданы (DATABASE_URL и др.).
- [ ] Сервис запускается и отвечает на запросы.
- [ ] Настроен автозапуск (systemd или pm2).
- [ ] Открыты порты 80/443 (или нужный порт) в security group.
- [ ] Фронт/клиенты переведены на новый URL API, работа проверена.

---

## Полезные ссылки

- [Yandex Compute Cloud](https://cloud.yandex.ru/docs/compute/)
- [Подключение к VM по SSH](https://cloud.yandex.ru/docs/compute/operations/vm-connect/ssh)
- [Тарификация Compute Cloud](https://cloud.yandex.ru/docs/compute/pricing)

Когда захочешь перейти к конкретным командам (установка Node, nginx, systemd) — можно расширить этот документ или спросить отдельно.
