# Идеи развития приложения: фичи и доработки

Обзор того, что уже есть, и что можно добавить. Удобно использовать для планирования спринтов и бэклога.

---

## Что уже есть (кратко)

- **Чаты:** список, папки, создание 1-1 и групп, участники, инвайты по коду, выход, передача владельца, переименование.
- **Сообщения:** текст, картинки, файлы, голосовые, редактирование, удаление, ответ/цитирование, пересылка, реакции, закрепление, прочитано, поиск по чату, галерея медиа, превью ссылок, упоминания @username.
- **Реальное время:** WebSocket (новые сообщения, печатает, онлайн), push-уведомления (FCM).
- **Офлайн:** кэш сообщений (Hive), очередь отправки, повтор при ошибке.
- **Профиль:** логин/ник, аватар, смена пароля, удаление аккаунта; EULA при первом входе.
- **Модерация:** жалоба на сообщение, блокировка пользователя.
- **Приватные разделы (по списку в env):** ученики, уроки, балансы, депозиты, отчёты, выгрузка учёта, загрузка банковской выписки.
- **Админ (суперпользователь):** сброс пароля пользователю, экспорт учёта/транзакций, настройка CORS бакета.

---

## Новые фичи и доработки

### Безопасность и вход

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Восстановление пароля** | «Забыли пароль?» → ввод email → письмо с ссылкой/кодом → смена пароля. В миграциях уже есть `recovery_email`, `password_reset_tokens` — можно довести до конца. | Средняя |
| **Двухфакторная аутентификация (2FA)** | TOTP (Google Authenticator и др.): включение в профиле, проверка кода при входе. | Высокая |
| **Подтверждение email** | При регистрации отправка письма с ссылкой; вход/восстановление пароля только после подтверждения. | Средняя |
| **Блокировка экрана** | PIN или биометрия при открытии приложения (опционально в настройках). | Средняя |
| **Выход по неактивности** | Автовыход после N минут без действий (настраиваемый таймаут). | Низкая |

### Чаты и сообщения

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Архив чатов** | Скрыть чат из основного списка в «Архив»; при новом сообщении — вернуть в список (как в Telegram). | Средняя |
| **Закреплённые чаты** | Отдельная секция «Закреплённые» вверху списка чатов (сейчас есть только папки). | Низкая |
| **Отключение уведомлений по чату** | Мут чата на 1 ч / 8 ч / навсегда; не слать push по этому чату. | Средняя |
| **Сообщения с самоуничтожением** | Таймер «удалить через N сек» после прочтения (как в Telegram). | Высокая |
| **Опросы в группах** | Создание опроса (вопрос + варианты), голосование, отображение результатов. | Высокая |
| **Треды в группах** | Ответ в ветку (reply in thread), отдельный экран/список ответов под сообщением. | Высокая |
| **Видеосообщения** | Запись короткого видео в чат (аналог голосовых, но видео). | Высокая |
| **Голосовые/видеозвонки** | Звонок 1-на-1 (и при желании группа) через WebRTC; сигнализация по WebSocket. См. раздел ниже. | Высокая |
| **Стикеры / GIF** | Набор стикеров или выбор GIF (например, GIPHY API) и отправка в чат. | Средняя |
| **Экспорт переписки** | Выгрузка чата в TXT/PDF (для себя или по запросу). | Средняя |

### Поиск и навигация

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Глобальный поиск** | Один поиск по всем чатам (по тексту, по отправителю, по дате). | Средняя |
| **Глубокие ссылки** | Открытие конкретного чата или сообщения по ссылке (например, myapp://chat/123 или https://app.example/chat/123). | Средняя |
| **Недавние / избранное** | Раздел «Недавно просмотренные» или закладки на чаты/сообщения. | Низкая |

### Внешний вид и настройки

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Светлая тема** | Переключатель «Тёмная / светлая / как в системе» в настройках; сохранение выбора. | Средняя |
| **Размер шрифта** | Настройка размера текста в чатах (малый / средний / большой) для доступности. | Низкая |
| **Звук уведомлений по чату** | Выбор звука (или без звука) для конкретного чата. | Низкая |
| **Язык приложения** | Полная локализация (русский / английский и др.) через l10n, не только отдельные строки. | Средняя |

### Удобство (UX)

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Свайпы в списке чатов** | Свайп влево: «Прочитать» / «Скрыть»; свайп вправо: «Закрепить» (дополнение к текущему «Удалить»). | Низкая |
| **Описание и аватар группы** | Редактирование описания группы и загрузка аватара группы (сейчас только название). | Низкая |
| **Настройка «Прочитано»** | Опция «Не отправлять статус прочитанного» (скрывать прочтение от собеседников). | Средняя |
| **Отображение «был(а) в сети»** | Более заметный last seen в профиле и в списке чатов (если уже есть на бэкенде — только UI). | Низкая |

### Админ и модерация

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Список пользователей для админа** | Экран со списком пользователей (поиск, фильтр), переход в профиль, сброс пароля, бан. | Средняя |
| **Роли в группе** | Расширение ролей: не только owner/admin, но и модератор (например, только удаление сообщений). | Средняя |
| **Журнал действий в чате** | Лог «кто кого добавил, кто вышел, кто удалил сообщение» для групп (для админов/модераторов). | Средняя |
| **Аналитика для админа** | Дашборд: кол-во пользователей, сообщений, активность по дням (по уже имеющимся данным в БД). | Средняя |

### Платформы и интеграции

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Виджет (Android / iOS)** | Виджет на домашний экран: счётчик непрочитанных или последние чаты. | Высокая |
| **Share Extension** | «Поделиться» из браузера/галереи — отправить в выбранный чат. | Высокая |
| **Планшет / iPad** | Master-detail: список чатов слева, чат справа; поддержка split view. | Средняя |
| **Desktop** | Улучшение UX на desktop: горячие клавиши, контекстное меню, drag-and-drop (частично уже есть). | Низкая–средняя |
| **Crash-репорты** | Интеграция Sentry (или аналога) для сбора ошибок в проде. | Низкая |
| **Проверка обновлений** | При запуске проверка новой версии в store и предложение обновиться. | Низкая |

### Долгосрочные / сложные

| Идея | Описание | Сложность |
|------|----------|-----------|
| **Секретные чаты (E2E)** | Сквозное шифрование для выбранных диалогов (Signal Protocol или аналог). | Очень высокая |
| **Каналы / рассылки** | Односторонние каналы с подписчиками (как Telegram-канал). | Высокая |
| **Боты / API** | Простой Bot API для автоматизации (отправка сообщений, ответы на команды). | Высокая |
| **Несколько аккаунтов** | Переключение между несколькими аккаунтами в одном приложении. | Высокая |
| **Резервное копирование** | Экспорт/импорт данных аккаунта (чаты, настройки) в файл или облако. | Высокая |

---

## Голосовые (и видео) звонки: насколько сложно

**Кратко:** сложность **высокая**, но не запредельная. Оценка: **3–6 недель** на минимальный рабочий вариант (только голос 1-на-1) при своих серверах или **1–2 недели**, если взять готовый облачный сервис (Twilio, Daily, Livekit, Agora).

### Что нужно по сути

1. **Сигнализация (signaling)**  
   Два пользователя должны обменяться данными для установки соединения: «кто звонит», «принять/отклонить», обмен SDP (offer/answer) и ICE-кандидатами. У вас уже есть **WebSocket** — по нему можно слать сообщения типа `call_invite`, `call_accept`, `call_reject`, `call_hangup` и передавать SDP/ICE. Реализация на бэкенде — новый тип сообщений в WebSocket + маршрутизация по `userId`/чату. **Сложность: средняя.**

2. **Клиент (Flutter)**  
   Нужен WebRTC в приложении: пакет **`flutter_webrtc`** (обёртка над нативным WebRTC на iOS/Android и Web). Задачи: запрос микрофона (и камеры для видео), создание peer connection, отправка/получение offer/answer и ICE по вашему WebSocket, отображение экрана звонка (входящий/исходящий/разговор), кнопки принять/отклонить/положить трубку. На **web** — те же API в браузере. **Сложность: высокая** (много состояний, разрешения, жизнь цикла приложения при фоне/блокировке экрана).

3. **NAT и файрволы (STUN/TURN)**  
   Часто два устройства не могут соединиться «напрямую». Нужны:
   - **STUN** — чтобы узнать свой публичный адрес (можно бесплатные серверы, например Google).
   - **TURN** — релей-сервер, если P2P не пробивается (по разным оценкам, 10–25% звонков без TURN не установятся). Варианты: поднять свой **coturn** на Yandex Cloud (ещё один сервис, порты, мониторинг) или взять **облачный TURN/медиа-сервер** (Twilio, Daily, Livekit и т.д.). **Сложность: средняя** (свой TURN) или **низкая** (если платный сервис даёт готовые URL и креды).

4. **Push и «звонок при закрытом приложении»**  
   Чтобы звонок «звонил», когда приложение в фоне или закрыто, нужен push (у вас уже FCM) + данные в push (payload с типом «incoming_call» и id звонка), по тапу — открыть приложение и подставить в экран звонка нужный контекст. Для iOS/Android есть нюансы с фоновой работой и ограничениями на фоновый звук. **Сложность: средняя.**

5. **Видео (если потом добавить)**  
   Тот же WebRTC, но добавляется видеопоток с камеры и отображение удалённого видео. Логика сигнализации та же, UI сложнее. **Сложность:** поверх голоса ещё +1–2 недели.

### Варианты реализации

| Подход | Плюсы | Минусы | Оценка по времени |
|--------|--------|--------|--------------------|
| **Всё сами (WebSocket + coturn + flutter_webrtc)** | Полный контроль, нет абонплаты за медиа | Нужно поднимать и содержать TURN, отлаживать обмен SDP/ICE, edge cases на разных сетях | 3–6 недель на голос 1-на-1 |
| **Облачный сервис (Twilio, Daily.co, Livekit, Agora)** | Готовые SDK, TURN/медиа на их стороне, часто есть Flutter/React Native примеры | Деньги за минуты/месяц, зависимость от провайдера | 1–2 недели на голос (и быстрее видео) |

### Сколько выйдет по деньгам, если всё делать сами (Yandex Cloud)

У вас уже есть ВМ и БД в Yandex Cloud. Дополнительные расходы только за **TURN-сервер** (coturn) и трафик релея.

**Вариант 1: coturn на той же ВМ, где крутится Node**

- **Доп. расходы: 0 ₽/мес** — ставите coturn рядом с приложением, открываете порты UDP 3478 и диапазон для релея (например 49152–65535 или меньше).
- Один голосовой поток ~40–80 kbps (Opus). Даже 5–10 одновременных звонков через TURN — нагрузка небольшая. Риск: если на этой ВМ уже мало CPU/RAM под пики, под релей лучше вынести coturn на отдельный инстанс.

**Вариант 2: отдельная маленькая ВМ под coturn**

- **ВМ:** в Yandex Cloud «стандартная» платформа, 2 vCPU, 2 GB RAM — ориентировочно **~2 000–3 500 ₽/мес** (цены меняются, смотрите [cloud.yandex.ru](https://cloud.yandex.ru)).
- **Трафик:** исходящий трафик в интернет часто тарифицируется после первых 10–30 GB/мес. Голос через TURN: ~0.5–1 MB на минуту разговора в обе стороны (релей дублирует поток). Допустим 500 минут релея в месяц — это порядка 0.5 GB. Даже при 5–10 ₽/GB доп. трафика это **десятки рублей**, не тысячи.
- **Итого:** примерно **2 000–4 000 ₽/мес** при отдельной ВМ под TURN. Если часть звонков идёт P2P (без TURN), трафик и нагрузка ещё меньше.

**Сигнализация** (WebSocket) уже у вас на текущей ВМ — новых серверов не нужно, рост нагрузки от звонков минимальный (мелкие JSON-сообщения).

**Резюме по деньгам:**

| Сценарий | Оценка в месяц |
|----------|-----------------|
| coturn на текущей ВМ | **0 ₽** (только время на настройку и порты) |
| Отдельная ВМ под coturn (2 vCPU, 2 GB) | **~2 000–4 000 ₽** + трафик (обычно небольшие суммы) |

**Выдержит ли та же ВМ (2 vCPU, 2 GB), если ставить coturn рядом с Node?**

Да, в типичном сценарии выдержит. На этой ВМ уже крутятся Node.js (чат + API), pm2 и, при наличии HTTPS, Caddy. По ресурсам это примерно 300–600 MB RAM и небольшой CPU в простое; пики — при обработке запросов и WebSocket.

coturn в режиме релея голоса съедает порядка **50–100 MB RAM** и немного CPU (пересылка UDP-пакетов). Один голосовой поток через TURN — это десятки килобит в секунду в каждую сторону. **5–10 одновременных звонков через TURN** на 2 vCPU и 2 GB — нагрузка умеренная, ВМ обычно не «ложится».

Ограничения, когда лучше не совмещать или усилить конфиг:

- **Много одновременных релеевых звонков** (условно 15–20+) — CPU и сеть могут упереться в лимит, появятся задержки или обрывы.
- **Видеозвонки** — видеопоток в разы тяжелее голоса; релей видео на той же ВМ быстро съест и CPU, и трафик. Тогда разумнее отдельная ВМ под coturn или облачный медиа-сервис.
- Если ВМ уже **урезана до 1 vCPU / 1 GB** (как в YANDEX_COST_REDUCTION) — оставлять только Node на ней, coturn выносить на отдельный инстанс или не поднимать свой TURN.

**Практический вывод:** для старта (только голос, несколько одновременных звонков) поднимать coturn на той же ВМ — нормально. Следить по `htop`/мониторингу за RAM и CPU в пиках. Если позже появятся десятки звонков или видео — перенести TURN на отдельную ВМ или перейти на облачный сервис.

### Итог

- **Только голосовые звонки 1-на-1** — реализуемо за **3–6 недель** при своей инфраструктуре (сигнализация по вашему WebSocket + coturn на Yandex Cloud + Flutter UI и `flutter_webrtc`).
- Если использовать **готовый сервис** (Daily, Livekit и т.п.) — **1–2 недели**, но будет ежемесячная плата за минуты/активных пользователей.
- **Видеозвонки** — те же компоненты, плюс камера и отображение видео; прирост по времени умеренный, если голос уже есть.
- Самые «больные» места: стабильность на разных сетях и мобильных устройствах (особенно iOS в фоне), поэтому на первом этапе разумно закладывать время на тесты и, при необходимости, быстрый переход на облачный медиа-сервис.

---

## Быстрые победы (низкая сложность)

1. Светлая тема + переключатель в настройках.  
2. Закреплённые чаты — отдельная секция вверху списка.  
3. Настройка размера шрифта в чате.  
4. Свайпы в списке чатов: «Прочитать», «Закрепить».  
5. Описание и аватар группы.  
6. «Был(а) в сети» в профиле и в списке чатов.  
7. Crash-репорты (Sentry).  
8. Проверка обновлений при старте приложения.

---

## Рекомендуемый порядок (по приоритету)

1. **Восстановление пароля** — часто запрашиваемая функция, миграции уже есть.  
2. **Светлая тема** — улучшает восприятие и доступность.  
3. **Архив чатов** — стандартная ожидаемая возможность в мессенджерах.  
4. **Глобальный поиск** — сильно упрощает поиск по старым перепискам.  
5. **Экспорт переписки** — польза для пользователей и соответствие ожиданиям.  
6. **Мут чата** — базовый контроль уведомлений.  
7. **Админ: список пользователей** — удобнее управлять пользователями и паролями.  
8. **2FA** — заметное усиление безопасности для тех, кому это важно.

Документ можно дополнять и менять приоритеты под свои цели (рост аудитории, монетизация, безопасность и т.д.).

---

## Как срубить деньжат: монетизация

Приложение уже заточено под репетиторов/преподавателей (ученики, уроки, балансы, отчёты). Ниже — рабочие модели, как на этом зарабатывать.

### 1. Подписка Freemium (самое предсказуемое)

**Бесплатно:** чаты без ограничений, но раздел «Ученики/учёт» — например, до **3 учеников** и до **10 уроков в месяц**. Либо только чат, а учёт — по коду/приглашению.

**Платный тариф (Pro):** безлимит учеников и уроков; экспорт отчётов в Excel/PDF; загрузка банковской выписки; приоритетная поддержка.

**Цены (ориентир):** 199–499 ₽/мес или 1 990–4 990 ₽/год (скидка 20–30%). Годовая подписка даёт стабильный кэш.

**Реализация:** в БД флаг `subscription_plan` (free | pro), на бэкенде проверка лимитов при создании ученика/урока. Оплата — ЮKassa, Stripe или подписки в App Store / Google Play.

---

### 2. Разовый разблок «Про»

Одноразовая покупка «Разблокировать учёт навсегда» за 2 990–4 990 ₽. Проще объяснить, нет отписок. Минус — один раз заплатил, дальше с пользователя не зарабатываешь. Часто комбинируют с лимитом: бесплатно 3 ученика → разовая покупка «без лимита» или подписка.

---

### 3. B2B: школы и студии

Целевая аудитория: языковые школы, курсы (5–20 преподавателей). Тариф «Организация» — фикс за месяц/год за количество учителей. Пример: 2 990 ₽/мес за до 10 преподавателей, общий учёт. Продажи — лично, лендинг, кейсы. Чек выше, цикл продаж длиннее.

---

### 4. Платные фичи

| Фича | Монетизация |
|------|--------------|
| Экспорт чата в PDF | 99–199 ₽ за экспорт или только в Pro |
| Расширенная аналитика | Только Pro |
| Больше хранилища (файлы/голосовые) | Лимит бесплатно, дальше Pro |
| Стикеры/темы | Наборы по 49–99 ₽ (когда появятся) |

---

### 5. Донаты

В настройках — «Поддержать проект»: ЮMoney, Boosty, Patreon или разовый платёж (ЮKassa/Stripe). Часть пользователей платит без давления. Бонус: бейдж «Supporter» в профиле или отдельная тема.

---

### 6. Рефералы

«Пригласи коллегу — получи месяц Pro». Рефералу — скидка на первый платёж. Учителя знают друг друга — сарафан даёт прирост платящих.

---

### 7. Белая метка (White Label)

Продавать тот же продукт под чужим брендом (школа, платформа). Оплата: лицензия или ежемесячно за инстанс. Нужна мультитенантность, кастомизация логотипа/домена. Окупается при 2–3 клиентах по 10–30k ₽/мес.

---

### Что сделать первым делом

1. **Ввести лимиты бесплатной версии** — например 3 ученика, 10 уроков/мес. В коде проверка при создании + сообщение «Перейдите на Pro».
2. **Экран тарифов в приложении** — что входит в Pro, цена/год, кнопка «Оформить».
3. **Одна платёжная система** — ЮKassa (РФ) или Stripe; для мобилок — In-App Purchases (Apple/Google), чтобы не нарушать правила сторизов.
4. **Делать упор на годовую подписку** — дешевле в пересчёте, но сразу крупная сумма и меньше отписок.

Комбо: freemium как база + донаты + позже B2B или белая метка для крупных клиентов.
