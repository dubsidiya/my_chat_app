# Как уменьшить стоимость обслуживания (Yandex Cloud + окружение)

Сейчас у тебя платятся в основном **ВМ** (Compute) и **Managed PostgreSQL** в Yandex Cloud. Ниже — конкретные шаги, как снизить сумму в месяц.

---

## 1. Виртуальная машина (ВМ)

### 1.1 Уменьшить конфигурацию ВМ

Скрипт `create-yandex-vm.sh` создаёт ВМ с **2 vCPU, 2 GB RAM, 15 GB диск**. Для лёгкого Node.js-чата часто хватает меньше.

**Что сделать в консоли Yandex Cloud:**

1. **Compute Cloud** → **Виртуальные машины** → твоя ВМ (**chat-server**) → **Остановить**.
2. После остановки открой ВМ → **Изменить** (или через меню «Изменить конфигурацию»).
3. Выбери **минимальный** или **burstable** пресет:
   - **1 vCPU** (или 2 vCPU с гарантированной долей 5–20%);
   - **1 GB RAM** (или 2 GB, если приложение уже падало по памяти).
4. **Диск:** если не нужны большие логи и файлы на диске — можно **10 GB** вместо 15 GB.
5. Сохрани и **запусти** ВМ снова.

**Эффект:** заметное снижение счёта за Compute (часто на 30–50% по сравнению с 2 vCPU / 2 GB). Точные цены: [тарификация Compute Cloud](https://cloud.yandex.ru/docs/compute/pricing).

**Важно:** после смены конфигурации проверь, что приложение стабильно работает под нагрузкой (логин, чаты, загрузки). Если появятся таймауты или падения — верни 2 GB RAM.

### 1.2 Останавливать ВМ, когда не нужна (тест/разработка)

Если сервер нужен не 24/7 (например, только для тестов или по вечерам):

- В консоли: **Виртуальные машины** → **chat-server** → **Остановить**.
- Пока ВМ остановлена, платишь в основном за **диск** (копейки), а не за vCPU/RAM.
- Когда понадобится — **Запустить**. IP может смениться, если не был зарезервирован статический адрес; DuckDNS тогда обнови вручную на новый IP.

Для **продакшена**, который должен быть доступен всегда, ВМ не останавливай.

---

## 2. База данных (Managed PostgreSQL)

### 2.1 Уже дёшево: один хост, минимальный класс

В [YANDEX_DB_MIGRATION.md](YANDEX_DB_MIGRATION.md) описана минимальная конфигурация: один хост, класс с долей vCPU (burstable), 10 GB диск. **Реплику не добавляй** — она почти удваивает стоимость.

### 2.2 Проверить класс хоста и размер диска

В консоли: **Managed Service for PostgreSQL** → кластер **chat-db** → настройки кластера/хоста.

- **Класс хоста:** должен быть самый дешёвый (минимальная доля vCPU, минимум RAM). Если выбран «стандартный» или более мощный — переключи на минимальный (если интерфейс позволяет изменить).
- **Диск:** 10 GB обычно достаточно для старта. Увеличивать только когда реально заканчивается место.

### 2.3 Не создавать лишних кластеров и баз

Один кластер, одна база `chat_db` — оптимально по деньгам. Дополнительные кластеры/базы для теста лучше не поднимать в облаке или удалять после тестов.

---

## 3. Сетевой трафик

- **Входящий** трафик в Yandex Cloud обычно не тарифицируется.
- **Исходящий** — часто платный после какого-то лимита в месяц (смотри [тарифы](https://cloud.yandex.ru/docs/compute/pricing#prices-traffic)).

**Как снизить расход:**

- Картинки/файлы отдавать по прямым ссылкам из **Object Storage** (у тебя уже так), а не проксировать большие объёмы через ВМ.
- Не качать с ВМ большие объёмы на свой компьютер без необходимости (бэкапы, логи — по делу).

---

## 4. Object Storage (если используешь)

В [YANDEX_CLOUD_SETUP.md](YANDEX_CLOUD_SETUP.md) указано порядка **~8–20 ₽/мес** — это уже мало.

Можно чуть сэкономить:

- Настроить **жизненный цикл** (lifecycle) для временных/старых файлов: автоматическое удаление через N дней.
- Не хранить в бакете то, что можно не хранить (дубликаты, старые превью и т.п.).

---

## 5. Гранты и промо Yandex Cloud

- Для **ИП/ООО** иногда доступен **грант 4000 ₽** (промокод и условия на [yandex.cloud](https://cloud.yandex.ru)). Грант можно тратить и на ВМ, и на БД — на несколько месяцев можно уложиться в ноль своих расходов.
- Акции и новые промо смотри в консоли и в рассылке Yandex Cloud.

---

## 6. Остальное окружение (почти бесплатно)

| Сервис | Сейчас | Что делать |
|--------|--------|------------|
| **Vercel** (фронт) | Бесплатный тариф | Оставить как есть; не переходить на платный без необходимости. |
| **DuckDNS** | Бесплатно | Ничего не менять. |
| **GitHub Actions** | Деплой + keepalive раз в 5 мин | Для приватного репо есть лимит минут; для публичного — бесплатно. Можно реже пинговать (например раз в 10–15 мин), если не боишься «холодного» старта после долгого простоя (у тебя ВМ не засыпает). |
| **Caddy (HTTPS)** | Бесплатно (Let's Encrypt) | Без изменений. |

---

## 7. Ориентир по суммам (после оптимизации)

| Компонент | До оптимизации (оценка) | После (оценка) |
|-----------|-------------------------|----------------|
| ВМ 2 vCPU, 2 GB, 15 GB | ~400–600 ₽/мес | ВМ 1 vCPU, 1 GB, 10 GB: ~200–400 ₽/мес |
| Managed PostgreSQL (мин.) | ~500–700 ₽/мес | Оставить минимум: ~500–700 ₽/мес |
| Трафик | 50–150 ₽/мес | Сократить исходящий: 0–50 ₽/мес |
| Object Storage | ~8–20 ₽/мес | Без изменений |
| **Итого** | **~1000–1500 ₽/мес** | **~700–1200 ₽/мес** (и меньше при гранте) |

Цены лучше уточнять в [калькуляторе Compute](https://cloud.yandex.ru/docs/compute/pricing) и [тарифах Managed PostgreSQL](https://cloud.yandex.ru/docs/managed-postgresql/pricing).

---

## 8. Краткий чеклист

- [ ] Уменьшить ВМ до 1 vCPU, 1 GB RAM (и при необходимости диск до 10 GB).
- [ ] Убедиться, что у БД минимальный класс хоста и один хост без реплики.
- [ ] Не добавлять реплику БД ради «красной галочки» HA, если бюджет ограничен.
- [ ] Исходящий трафик не раздувать (раздача файлов через Object Storage, а не через ВМ).
- [ ] Проверить гранты/промо Yandex Cloud для ИП/ООО.
- [ ] Останавливать ВМ в нерабочее время только если это не продакшен.

Если напишешь текущую конфигурацию ВМ (vCPU, RAM, диск) и пример счёта за месяц, можно точечно подсказать, что выгоднее уменьшить в первую очередь.
