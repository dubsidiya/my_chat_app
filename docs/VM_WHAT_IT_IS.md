# Что такое ВМ и как она устроена у тебя

Простое объяснение: что за «ВМ», как она работает и что на ней реально крутится в твоём проекте.

---

## ВМ — это «компьютер внутри компьютера»

**Виртуальная машина (ВМ, VM)** — это не железный ящик под столом, а **программа**, которая ведёт себя как отдельный компьютер. У неё есть свои «процессор», «память», «диск», «сетевой адрес» — но всё это выделено из одного большого физического сервера в дата-центре.

- **Физический сервер** — реальный компьютер в стойке Yandex (много ядер CPU, много RAM, диски). На нём установлена особая программа — **гипервизор** (KVM, VMware и т.п.). Она «нарезает» ресурсы сервера на куски и каждому куску даёт свою виртуальную машину.
- **Твоя ВМ** — один такой кусок: например, 2 ядра CPU, 2 GB RAM, диск 15 GB. Для ОС и приложений внутри ВМ это выглядит как отдельный компьютер с таким железом.

Ты не видишь соседей по железу и не управляешь гипервизором — ты работаешь только со своей ВМ: включаешь/выключаешь её, меняешь размер (больше RAM/CPU), ставишь на неё ОС и софт.

---

## Что конкретно у тебя за ВМ

В Yandex Cloud у тебя создана одна ВМ (скриптом `scripts/create-yandex-vm.sh` или вручную в консоли). У неё:

- **Имя:** например `chat-server`
- **Ресурсы:** 2 vCPU (виртуальных ядра), 2 GB оперативной памяти, диск 15 GB
- **ОС:** образ Ubuntu 22.04 LTS (как если бы ты установил Ubuntu на свой ноутбук)
- **Сеть:** у ВМ есть внутренний IP в сети Yandex и **публичный IP** (например 93.77.185.6), чтобы к ней можно было стучаться из интернета по SSH и по HTTP/HTTPS

Пока ВМ **включена**, за неё идёт списание по тарифу (vCPU + RAM + диск + трафик). Когда ВМ **остановлена**, платишь в основном за диск; CPU и RAM не тарифицируются.

---

## Что реально работает «внутри» этой ВМ

Когда ты подключаешься по SSH (`ssh -i scripts/.deploy_key ubuntu@93.77.185.6`), ты попадаешь в **Linux (Ubuntu)** на этой ВМ. Там установлено и запущено примерно следующее.

### 1. Операционная система (Ubuntu)

- Файловая система, пользователи, сеть, фоновые службы — как на обычном Linux-сервере.
- Пользователь, под которым ты заходишь и под которым крутится приложение — обычно `ubuntu`.

### 2. Твой код приложения

- В каталоге `~/my_chat_app/` лежит репозиторий: бэкенд в `my_serve_chat_test/` (Node.js, Express, WebSocket и т.д.).
- Код подтягивается вручную (rsync, git clone) или через **GitHub Actions**: при push в `main` workflow подключается по SSH к ВМ и выполняет `git fetch`, `npm ci`, `pm2 restart chat-server`.

### 3. Node.js

- Установленная среда выполнения для JavaScript. Твой сервер — это процесс Node, который запускает `index.js`: поднимает HTTP-сервер (порт 3000), WebSocket, подключается к БД (Managed PostgreSQL в Yandex — это уже **другая** машина/сервис, не эта ВМ).

### 4. pm2

- Менеджер процессов: держит твой Node-процесс (`chat-server`) запущенным. Если процесс упал — pm2 его перезапустит. После перезагрузки ВМ pm2 стартует сам (через `pm2 startup`) и поднимает приложение снова.

### 5. Caddy (если настроен HTTPS)

- Отдельный процесс: слушает порты 80 и 443, принимает HTTPS-запросы, получает сертификаты Let's Encrypt и проксирует запросы на твой Node (порт 3000). То есть «снаружи» пользователь ходит на `https://api.твой-домен.ru`, а внутри ВМ запрос уходит на `http://localhost:3000`.

### 6. (В будущем) coturn

- Если добавишь голосовые звонки и поставишь coturn на эту же ВМ — ещё один процесс: TURN-сервер для WebRTC, слушает UDP-порты и ретранслирует медиа-трафик между клиентами.

---

## Как ты с ней взаимодействуешь

| Действие | Как делается |
|----------|----------------|
| Зайти «на сервер» | SSH: `ssh -i scripts/.deploy_key ubuntu@93.77.185.6` — попадаешь в терминал внутри ВМ |
| Обновить код и перезапустить приложение | Вручную: зайти по SSH, `cd ~/my_chat_app`, `git pull`, `cd my_serve_chat_test`, `npm ci`, `pm2 restart chat-server`. Либо автоматически: push в `main` → GitHub Actions делает то же самое по SSH |
| Посмотреть логи | SSH → `pm2 logs chat-server` или `pm2 monit` |
| Поменять конфиг (переменные окружения) | SSH → редактировать `~/my_chat_app/my_serve_chat_test/.env`, затем `pm2 restart chat-server` |
| Открыть порты (сеть) | В консоли Yandex Cloud: группа безопасности ВМ — разрешить входящий TCP на 22 (SSH), 3000 (или 80/443, если стоит Caddy) |

БД (PostgreSQL) у тебя **не на этой ВМ** — это отдельный сервис Yandex (Managed Service for PostgreSQL). ВМ только подключается к нему по сети по `DATABASE_URL` из `.env`.

---

## Схема «кто куда стучится»

```
[Пользователь: браузер / Flutter-приложение]
         |
         | HTTPS (или HTTP) на твой домен / IP
         v
[Интернет]
         |
         v
[ВМ в Yandex: публичный IP, порты 80/443 открыты]
         |
         +-- Caddy (если есть) слушает 80/443, проксирует на localhost:3000
         |
         +-- Node.js (index.js) слушает 3000: API, WebSocket, логика чата
         |
         +-- (опционально) coturn слушает UDP для звонков
         |
         v
[Подключение к БД по сети]
         |
         v
[Managed PostgreSQL в Yandex] — отдельный сервис, не эта ВМ
```

---

## Итог одной фразой

**ВМ — это выделенный тебе виртуальный «компьютер» в облаке Yandex с Ubuntu, на котором крутятся твой Node-сервер (чат + API), pm2 и при необходимости Caddy и coturn; к нему ты заходишь по SSH и деплоишь код вручную или через GitHub Actions; база данных живёт отдельно в Managed PostgreSQL.**

---

## Почему не запустить то же самое на своём компьютере?

**Запустить можно.** На своём компе ты можешь поднять тот же Node-сервер: `cd my_serve_chat_test`, `npm install`, `node index.js` — сервер будет слушать, например, `http://localhost:3000`. Так обычно и делают при разработке: бэкенд локально, Flutter-приложение в эмуляторе или на телефоне в той же Wi‑Fi сети указывает `API_BASE_URL=http://192.168.x.x:3000` и стучится на твой комп.

**Почему для «нормального» доступа из интернета используют ВМ в облаке:**

1. **Доступность 24/7** — твой компьютер может быть выключен, в сне, перезагружается. Друзья или пользователи с телефона должны в любой момент открыть чат — для этого сервер должен быть всегда включён и в сети. ВМ в дата-центре работает постоянно.

2. **Доступ из интернета** — дома у тебя обычно **динамический IP** (провайдер меняет его) и нет белого статического IP «напрямую». Даже если бы был, многие провайдеры **режут входящие** на порты 80, 443, 3000 или держат клиентов за NAT. То есть с другого конца света (или просто с мобильного интернета) до «сервера у тебя дома» достучаться сложно или невозможно. У ВМ в облаке есть постоянный публичный IP и открытые порты — к ней можно обращаться откуда угодно.

3. **Надёжность и изоляция** — дома отключили свет, обновилась система, что-то «подвисло» — сервис пропадёт. В дата-центре питание и сеть резервируются. Плюс ВМ изолирована от твоего личного ПК: взлом или DDoS бьют по облаку, а не по домашней сети.

4. **База данных** — Managed PostgreSQL в Yandex живёт в той же облачной сети, что и ВМ — низкая задержка и не нужно поднимать и обслуживать БД у себя дома.

**Итог:** локально на своём компьютере запускать тот же бэкенд — нормально и нужно для разработки. Чтобы приложением могли пользоваться с любого устройства и в любое время через интернет, сервер поднимают на ВМ (или другом облачном сервере) с белым IP и постоянной работой.

Если захочешь углубиться в детали (как именно создаётся ВМ в консоли, что такое vCPU и как считается тариф) — можно открыть [YANDEX_SERVER_MIGRATION.md](YANDEX_SERVER_MIGRATION.md) и [тарификацию Compute Cloud](https://cloud.yandex.ru/docs/compute/pricing).
