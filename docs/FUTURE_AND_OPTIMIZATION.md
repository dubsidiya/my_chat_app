# Идеи на будущее и оптимизация

Документ для планирования улучшений UX и производительности приложения.

---

## Что добавить пользователю (на будущее)

### Удобство и UX
- **Поиск по сообщениям в чате** — ✅ есть (иконка в шапке чата): API-поиск + локальный поиск по загруженным при ошибке/офлайн, переход к сообщению с подсветкой.
- **Ответ/цитирование из списка** — ✅ есть: длинный тап по сообщению → «Ответить» в меню.
- **Свайп-действия в списке чатов** — свайп влево: «Прочитать» / «Скрыть», свайп вправо: «Закрепить».
- **Группировка сообщений по дате** — ✅ сделано: заголовки «Сегодня», «Вчера», «15 февраля» в ленте.
- **Индикатор «печатает…»** — уже есть через WebSocket; убедиться, что он заметен и не мигает.
- **Звук/вибрация при новом сообщении** — ✅ сделано: настройки в меню (Настройки), звук (SystemSound) + вибрация (HapticFeedback) при новом сообщении в открытом чате.
- **Папки/метки для чатов** — «Работа», «Личное», «Архив» для быстрой фильтрации.
- **Экспорт чата** — выгрузка переписки в текст/PDF (для отчётов и бэкапов).
- **Доступность (a11y)** — семантика для экранных читалок, размер шрифта в настройках, контраст.

### Надёжность и офлайн
- **Очередь отправки офлайн** — ✅ сделано: индикатор «В очереди: N сообщ. — отправятся при подключении» над полем ввода.
- **Retry при ошибке сети** — ✅ сделано: при ошибке загрузки чатов — экран с кнопкой «Повторить» и SnackBar с действием «Повторить»; в чате при ошибке загрузки сообщений уже была кнопка «Повторить».
- **Синхронизация прочитанных** — при возврате в чат помечать сообщения прочитанными и синхронизировать с сервером.

### Безопасность и конфиденциальность
- **Блокировка экрана** — PIN/биометрия при входе в приложение (опционально).
- **Секретные чаты** — локальное шифрование (E2E) для выбранных диалогов (сложно, долгосрочно).
- **Автовыход** — выход из аккаунта после N минут неактивности (настройка).

### Производительность и масштаб
- **Виртуализация длинных списков** — список сообщений уже на `ListView.builder`; при росте нагрузки рассмотреть `SliverList` + фиксированные заголовки по дате.
- **Кэш изображений** — ✅ сделано: `cached_network_image` с memCacheWidth, placeholder и errorWidget.
- **Ленивая загрузка вложений** — не подгружать превью файлов, пока ячейка не в зоне видимости (уже частично за счёт ListView.builder).

---

## Что уже сделано по оптимизации

- **Пагинация сообщений** — подгрузка старых сообщений порциями (50), кнопка «Загрузить старые».
- **Кэш сообщений в Hive** — офлайн-режим, быстрый старт при повторном открытии чата.
- **Проверка сети без connectivity_plus** — один лёгкий HTTP-запрос вместо тяжёлого SDK (и соответствие Apple privacy).
- **ListView.builder для сообщений и чатов** — не строится весь список сразу.
- **cached_network_image** — дисковый кэш изображений; memCacheWidth 500px (превью) / 1920px (полный экран); меньше трафика и памяти.
- **ListView: cacheExtent (800/500)** — предзагрузка элементов для плавного скролла.
- **RepaintBoundary** — изоляция перерисовки ячеек сообщений и чатов.
- **addAutomaticKeepAlives: false** — меньше памяти при длинных списках сообщений.
- **Кэш _listEntries** — избежание повторного построения списка при каждом build.
- **WebSocket для новых сообщений** — без постоянного опроса.
- **Тема (светлая/тёмная)** — кэшируется в `main.dart`, не пересоздаётся при каждом rebuild.

---

## Рекомендации по коду (уже учтены или к внедрению)

1. **print()** — ✅ сделано: все `print()` обёрнуты в `if (kDebugMode)`.
2. **Тема** — хранить `ThemeData` для light/dark в полях состояния или константах, чтобы не вызывать `buildTheme()` на каждый `build`.
3. **Сервисы** — не создавать `MessagesService()`/`ChatsService()` в `build`; уже вынесены в поля state (OK).
4. **Крупный ChatScreen** — файл ~4500 строк; в перспективе разбить на виджеты: список сообщений, ячейка сообщения, панель ввода, диалоги — для читаемости и тестов.
5. **Анализ** — периодически запускать `flutter analyze` и исправлять предупреждения.

---

## Чек-лист перед релизом

- [ ] Убрать или обернуть в `kDebugMode` все `print()` в горячих путях и errorBuilder.
- [ ] Проверить размер сборки: `flutter build apk --analyze-size` / iOS equivalent.
- [ ] Прогнать на устройстве с медленной сетью и включённым «Low Data Mode».
- [ ] Убедиться, что офлайн-сценарий (очередь сообщений, кэш) работает и понятен пользователю.
