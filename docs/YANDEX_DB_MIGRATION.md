# План: перенос БД на Yandex Cloud

Краткий план и пошаговые инструкции. Ничего не нужно делать срочно — это ориентир, когда будешь готов.

---

## Общая идея

1. Создать БД в Yandex (Managed PostgreSQL).
2. Перенести туда данные с текущей БД (Neon).
3. Поменять на сервере (Render) одну переменную — `DATABASE_URL`.
4. Сервер остаётся на Render, только подключается к новой БД.

---

## Как сделать максимально дёшево на первое время

**Важно:** у Yandex Managed PostgreSQL нет бесплатного тарифа (в отличие от Neon). Платить придётся с первого дня, но сумму можно сильно снизить.

### Минимальная конфигурация кластера

- **Класс хоста** — самый дешёвый с долей vCPU (burstable): 5% или 20% vCPU, минимум RAM. В интерфейсе это обычно варианты типа «Минимальная» или с пометкой про тестирование.
- **Один хост** — без реплик и без высокой доступности. Реплики добавлять только когда понадобится (см. ниже про HA).
- **Диск** — 10 GB на старте хватает для небольшого чата; при необходимости потом увеличишь.
- **Один кластер, одна БД** — не создавать лишних баз и веток.

### Высокая доступность (HA): добавление реплики

Чтобы убрать предупреждение «Отсутствие HA-реплик», можно добавить реплику в другую зону — **но это примерно удваивает стоимость кластера** (платишь за два хоста вместо одного). Если бюджет ограничен, реплику лучше не добавлять.

Если нужна HA, через CLI:

```bash
yc managed-postgresql hosts add \
  --cluster-name chat-db \
  --folder-id <твой-folder-id> \
  --host "zone-id=ru-central1-b,subnet-name=default-ru-central1-b,assign-public-ip=true" \
  --async
```

Удалить реплику (вернуть один хост и снизить счёт):  
`yc managed-postgresql hosts delete <имя-хоста-реплики> --cluster-name chat-db --folder-id <folder-id> --async`

При такой конфигурации ориентировочно **от ~500–700 ₽/мес** (цены могут меняться, лучше проверить в [калькуляторе Yandex Cloud](https://cloud.yandex.ru/docs/managed-postgresql/pricing) или при создании кластера).

### Если есть ИП/ООО

- Для новых бизнес-аккаунтов иногда доступен **грант 4000 ₽** (по промокоду и при выполнении условий). Тогда первые месяцы можно уложиться в грант. Условия и промокоды смотри на [yandex.cloud](https://cloud.yandex.ru).

### Сравнение с Neon

| | Neon (free) | Yandex (минимальный кластер) |
|---|---|---|
| Стоимость | 0 ₽ | ~500–700 ₽/мес |
| Хранилище | 0.5 GB | 10 GB и больше |
| Ограничения | Лимит по объёму, compute-часы | По деньгам, лимитов по размеру БД больше |

**Итог:** если цель — ноль расходов «на первое время», логично оставаться на Neon, пока хватает 0.5 GB. Перенос на Yandex имеет смысл, когда нужны объём, стабильность или данные в РФ — тогда выбирай минимальную конфигурацию выше, чтобы вышло максимально дёшево.

---

## План по шагам

### Шаг 1. Создать кластер в Yandex Cloud

- Зайти в консоль Yandex Cloud → **Managed Service for PostgreSQL** → **Создать кластер**.
- Указать: имя кластера, версию PostgreSQL (15/16), размер диска, имя БД, пользователя и пароль.
- Включить **публичный доступ**, если будешь подключаться с Render или с компьютера.
- Дождаться создания, записать **хост**, **порт**, имя БД, логин и пароль.

Подробности: [документация Yandex Managed PostgreSQL](https://cloud.yandex.ru/docs/managed-postgresql/).

---

### Шаг 2. Разрешить подключения к БД

- В настройках сети / Security groups кластера открыть порт (обычно **6432** или 5432) для входящих подключений.
- Указать источник: IP сервера Render или, для теста, 0.0.0.0/0.

Без этого подключение извне не заработает.

---

### Шаг 3. Составить новую строку подключения

Формат:

```
postgresql://USER:PASSWORD@HOST:PORT/DATABASE?sslmode=require
```

Подставить свои: пользователь, пароль, хост из консоли Yandex, порт, имя БД. Параметр `?sslmode=require` обязателен.

Эту строку потом поставишь в Render как новый `DATABASE_URL`.

---

### Шаг 4. Решить, как переносить данные

**Вариант A — полный перенос (дамп и восстановление)**

- Сделать дамп текущей БД (Neon) с помощью `pg_dump`.
- Восстановить дамп в новую БД в Yandex с помощью `pg_restore`.
- В итоге в Yandex будет копия текущей БД со схемой и данными.

**Вариант B — новая БД с нуля**

- В пустой БД в Yandex применить схему и миграции (есть скрипт `scripts/run-all-migrations.js`).
- Если нужны старые данные — отдельно экспортировать только данные с Neon и импортировать в Yandex.

На этом этапе достаточно выбрать вариант; сами команды можно выполнить позже.

---

### Шаг 5. Проверить подключение к Yandex

- Временно подставить новую строку подключения (из шага 3) в `.env` локально или в тестовый скрипт.
- Убедиться, что приложение или `psql` подключается к БД и видит таблицы/данные.

---

### Шаг 6. Переключить Render на Yandex

- В Render → твой сервис → **Environment**.
- Заменить значение **DATABASE_URL** на новую строку (из шага 3 или из `DATABASE_URL_YANDEX` в `.env`).
- Сохранить и дождаться перезапуска.
- Проверить логи и работу приложения.

После этого приложение работает с БД в Yandex. Старую БД можно оставить как резерв или отключить позже.

**Миграция данных уже выполнена** скриптом `my_serve_chat_test/scripts/migrate-neon-to-yandex.js` (дамп с Neon восстановлен в Yandex). Осталось только переключить Render на новый `DATABASE_URL`.

---

## Как посмотреть перенесённую БД в Yandex Cloud

### 1. В консоли (браузер)

1. Зайди в [консоль Yandex Cloud](https://console.yandex.cloud) → **Managed Service for PostgreSQL**.
2. Выбери кластер **chat-db**.
3. Вкладка **«Базы данных»** — там будет база **chat_db** (владелец chat_app).
4. Вкладка **«Мониторинг»** — графики по нагрузке и соединениям.
5. Чтобы выполнять SQL и смотреть таблицы/данные из браузера: в карточке кластера нажми **«Подключиться»** — там будет строка для `psql` и, если включён доступ, **Web SQL** (выполнение запросов в консоли). Если Web SQL нет — подключайся с компьютера (см. ниже).

### 2. С компьютера через psql

Из каталога `my_serve_chat_test` (в `.env` должен быть `DATABASE_URL_YANDEX`):

```bash
psql "$DATABASE_URL_YANDEX" -c "\dt"
```

Так увидишь список таблиц. Другие полезные команды:

- `\dt` — список таблиц
- `\d+ users` — структура таблицы `users`
- `SELECT COUNT(*) FROM messages;` — число записей в `messages`

Подставить URL вручную:

```bash
psql "postgresql://chat_app:ПАРОЛЬ@rc1a-fb78j7h9hisgnsll.mdb.yandexcloud.net:6432/chat_db?sslmode=require" -c "\dt"
```

### 3. Через CLI (yc)

Список баз в кластере:

```bash
yc managed-postgresql database list --cluster-name chat-db --folder-id <твой-folder-id>
```

Так в ЯО видно саму БД; содержимое (таблицы и данные) удобнее смотреть через **Подключиться → psql** в консоли или через `psql` локально.

---

## Чек-лист (когда будешь делать)

- [ ] Кластер в Yandex создан, есть хост, порт, логин, пароль, имя БД.
- [ ] Публичный доступ включён, порт открыт в security group.
- [ ] Строка подключения со `sslmode=require` составлена и сохранена.
- [ ] Выбран способ переноса (дамп или схема с нуля + данные).
- [ ] Данные перенесены, подключение к Yandex проверено.
- [ ] На Render обновлён `DATABASE_URL`, сервис перезапущен и проверен.

---

## Полезные ссылки

- [Yandex Cloud: Managed Service for PostgreSQL](https://cloud.yandex.ru/docs/managed-postgresql/)
- [Подключение к кластеру](https://cloud.yandex.ru/docs/managed-postgresql/operations/connect)

Когда захочешь перейти к конкретным командам (pg_dump, pg_restore, скрипты) — можно расширить этот документ или спросить отдельно.
